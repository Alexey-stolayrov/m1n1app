<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.hide();

    // ==== ПОЛУЧАЕМ БАЛАНС ОТ БОТА ====
    const params = new URLSearchParams(window.location.search);
    let balance = parseInt(params.get("balance")) || 0;

    document.getElementById("balance").innerText = balance;

    let currentGame = '';
    let towerHeight = 0;
    let buildingInterval;

    function startGame(gameType) {
        currentGame = gameType;
        document.getElementById('mainMenu').classList.add('hidden');

        if (gameType === 'tower_build') {
            document.getElementById('towerGame').classList.remove('hidden');
            initTower();
        } else if (gameType === 'coin_flip') {
            document.getElementById('coinGame').classList.remove('hidden');
        } else if (gameType === 'dice_roll') {
            document.getElementById('diceGame').classList.remove('hidden');
        }
    }

    function backToMenu() {
        document.getElementById('towerGame').classList.add('hidden');
        document.getElementById('coinGame').classList.add('hidden');
        document.getElementById('diceGame').classList.add('hidden');
        document.getElementById('mainMenu').classList.remove('hidden');
    }

    // ==== БАШНЯ ====
    function initTower() {
        towerHeight = 0;
        document.getElementById('height').textContent = '0';
        document.getElementById('tower').innerHTML = '';
    }

    function startBuilding() {
        buildingInterval = setInterval(() => {
            towerHeight++;
            document.getElementById('height').textContent = towerHeight;

            const floor = document.createElement('div');
            floor.className = 'floor';
            document.getElementById('tower').prepend(floor);

            if (towerHeight >= 100) {
                stopBuilding();
            }
        }, 100);
    }

    function stopBuilding() {
        clearInterval(buildingInterval);
        setTimeout(() => {
            if (towerHeight > 0) {
                finishGame(towerHeight);
            }
        }, 500);
    }

    // ==== МОНЕТА ====
    function flipCoin(choice) {
        tg.sendData(JSON.stringify({
            game_type: 'coin_flip',
            bet: 50,
            choice: choice
        }));
    }

    // ==== КУБИК ====
    function guessDice(number) {
        tg.sendData(JSON.stringify({
            game_type: 'dice_roll',
            bet: 75,
            guess: number
        }));
    }

    // ==== ЗАВЕРШЕНИЕ ИГРЫ ====
    function finishGame(score) {
        tg.sendData(JSON.stringify({
            game_type: currentGame,
            bet: currentGame === 'tower_build' ? 100 :
                 currentGame === 'coin_flip' ? 50 : 75,
            score: score
        }));
    }
</script>
